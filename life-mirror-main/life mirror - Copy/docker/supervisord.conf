[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:lifemirror-api]
command=python lifemirror_api.py
directory=/app
user=appuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/api.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=FLASK_ENV="production",FLASK_APP="lifemirror_api.py",PYTHONPATH="/app"

[program:gunicorn]
command=gunicorn --bind 0.0.0.0:8000 --workers 4 --worker-class gthread --threads 2 --timeout 300 --keep-alive 2 --max-requests 1000 --max-requests-jitter 100 lifemirror_api:app
directory=/app
user=appuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/gunicorn.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=FLASK_ENV="production",FLASK_APP="lifemirror_api.py",PYTHONPATH="/app"

[program:uvicorn]
command=uvicorn lifemirror_api:app --host 0.0.0.0 --port 9000 --workers 4 --loop uvloop --http httptools
directory=/app
user=appuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/uvicorn.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=FLASK_ENV="production",FLASK_APP="lifemirror_api.py",PYTHONPATH="/app"

[program:redis]
command=redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
user=redis
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/redis.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10

[program:nginx]
command=nginx -g "daemon off;"
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/nginx.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10

[group:lifemirror]
programs=lifemirror-api,gunicorn,uvicorn,redis,nginx
priority=999 